<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad: Sombrero Pirata</title>
    
    <!-- Cargamos React, ReactDOM y Babel para que funcione en el navegador -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Cargamos Tailwind CSS para el dise√±o -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuente estilo manuscrita para el t√≠tulo -->
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .font-hand { font-family: 'Indie Flower', cursive; }
        /* Animaciones suaves */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-sky-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS SVG (Para no depender de librer√≠as externas complejas) ---
        const Icon = ({ path, color = "currentColor", size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Anchor: (props) => <Icon {...props} path={<><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></>} />,
            Skull: (props) => <Icon {...props} path={<><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l-.5-4"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            HelpCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            XCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />,
            Highlighter: (props) => <Icon {...props} path={<><path d="M9 11l-6 6v3h9l3-3"/><path d="M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></>} />,
            PenTool: (props) => <Icon {...props} path={<><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />,
            Send: (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            Copy: (props) => <Icon {...props} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />
        };

        function App() {
            // --- Estados Globales ---
            const [studentName, setStudentName] = useState("");
            const [studentCourse, setStudentCourse] = useState("4¬∞A");
            const [hasStarted, setHasStarted] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            
            // --- Datos de la Actividad ---
            const textContent = {
                title: "C√≥mo hacer un Sombrero Pirata",
            };

            const questions = [
                {
                    id: 0,
                    type: "intro",
                    text: "Antes de leer, observa la estructura y el t√≠tulo. ¬øQu√© tipo de texto crees que es este?",
                    options: [
                        "Un cuento sobre piratas famosos.",
                        "Una noticia sobre barcos antiguos.",
                        "Un texto instructivo para hacer manualidades.",
                        "Un poema dedicado al mar."
                    ],
                    correct: 2,
                    skill: "Conocimiento previo / Estructura",
                    feedbackCorrect: (name) => `¬°Correcto, ${name}! Tiene lista de materiales y pasos ordenados, t√≠pico de un instructivo.`,
                    feedbackWrong: (name) => `F√≠jate en el formato, ${name}. ¬øVes que hay pasos numerados (1, 2, 3...)? Eso nos dice c√≥mo hacer algo.`
                },
                {
                    id: 1,
                    type: "simce",
                    text: "1. Seg√∫n el texto, ¬øqu√© debes hacer justo despu√©s de dibujar la forma del sombrero?",
                    options: [
                        "Pegar la calavera en el centro.",
                        "Recortar la silueta con tijeras.",
                        "Medir tu cabeza con la cartulina.",
                        "Pintar el papel de color negro."
                    ],
                    correct: 1,
                    skill: "Localizar Informaci√≥n",
                    hint: "Busca el Paso 2 en el texto.",
                    feedbackCorrect: (name) => `¬°Muy bien, ${name}! El Paso 2 dice expl√≠citamente: 'Recorta la silueta que dibujaste'.`,
                    feedbackWrong: (name) => `Revisa el orden de los n√∫meros, ${name}. ¬øQu√© dice el paso n√∫mero 2?`
                },
                {
                    id: 2,
                    type: "simce",
                    text: "2. ¬øPor qu√© se recomienda usar un l√°piz blanco o tiza en el Paso 5?",
                    options: [
                        "Porque es el √∫nico l√°piz que corta el papel.",
                        "Para que el dibujo resalte sobre la cartulina negra.",
                        "Porque a los piratas les gusta el color blanco.",
                        "Para poder borrar si te equivocas al dibujar."
                    ],
                    correct: 1,
                    skill: "Inferir / Causa y efecto",
                    hint: "Piensa en el color de la cartulina (Paso 1).",
                    feedbackCorrect: (name) => `¬°Exacto, ${name}! Como la cartulina es negra (Paso 1), un l√°piz oscuro no se ver√≠a. El blanco resalta.`,
                    feedbackWrong: (name) => `Relaciona la informaci√≥n, ${name}. En el paso 1 dice que la cartulina es negra. ¬øSe ver√≠a un l√°piz negro sobre fondo negro?`
                },
                {
                    id: 3,
                    type: "simce",
                    text: "3. ¬øCu√°l es la funci√≥n principal de la 'tira larga' mencionada en el Paso 3?",
                    options: [
                        "Servir como una espada de juguete.",
                        "Decorar la parte superior del sombrero.",
                        "Formar un cintillo para ajustar el sombrero a la cabeza.",
                        "Reforzar las puntas del tricornio."
                    ],
                    correct: 2,
                    skill: "Prop√≥sito local / Interpretar",
                    hint: "Lee atentamente el Paso 3.",
                    feedbackCorrect: (name) => `¬°Excelente, ${name}! El texto dice que el cintillo es para formar un c√≠rculo de 'tu talla'.`,
                    feedbackWrong: (name) => `Vuelve al Paso 3, ${name}. Ah√≠ explica para qu√© sirve esa tira y qu√© debes hacer con ella (formar un c√≠rculo).`
                },
                {
                    id: 4,
                    type: "simce",
                    text: "4. Si te saltaras el Paso 3 y pegaras el sombrero directamente, ¬øqu√© problema tendr√≠as?",
                    options: [
                        "El sombrero no tendr√≠a la forma de tricornio.",
                        "No podr√≠as ponerte el sombrero en la cabeza.",
                        "La calavera no se ver√≠a bien.",
                        "El papel se romper√≠a al cortar."
                    ],
                    correct: 1,
                    skill: "Reflexi√≥n / Predicci√≥n",
                    hint: "Recuerda qu√© parte del sombrero va en contacto con tu cabeza.",
                    feedbackCorrect: (name) => `¬°Bien pensado, ${name}! El cintillo (Paso 3) es la base que sujeta el sombrero a tu cabeza.`,
                    feedbackWrong: (name) => `Pi√©nsalo, ${name}. El tricornio es plano. Sin el cintillo circular del paso 3, ¬øc√≥mo se sostendr√≠a en tu cabeza?`
                },
                {
                    id: 5,
                    type: "simce",
                    text: "5. ¬øCu√°l es el prop√≥sito principal de este texto?",
                    options: [
                        "Contar la historia de Barbanegra.",
                        "Convencerte de que los piratas eran buenos.",
                        "Ense√±arte a fabricar un accesorio de disfraz.",
                        "Informar sobre los tipos de cartulinas."
                    ],
                    correct: 2,
                    skill: "Prop√≥sito Global",
                    hint: "Mira el t√≠tulo y lo que obtienes al final.",
                    feedbackCorrect: (name) => `¬°Perfecto, ${name}! El objetivo es que aprendas a crear (fabricar) tu propio sombrero.`,
                    feedbackWrong: (name) => `No es solo informaci√≥n, ${name}. Al terminar de leer y seguir los pasos, ¬øqu√© has logrado hacer?`
                },
                {
                    id: 6,
                    type: "opinion",
                    text: "Pregunta de Opini√≥n: ¬øCrees que es importante decorar el sombrero con la calavera (Paso 5)? ¬øPor qu√©?",
                    placeholder: "Yo opino que s√≠/no es importante porque...",
                    skill: "Reflexi√≥n Cr√≠tica",
                    checklist: ["Tomar postura (S√≠/No)", "Usar la palabra 'porque'", "Relacionar con el tema 'pirata'"]
                }
            ];

            // --- Estados de la Actividad ---
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [textHtml, setTextHtml] = useState(""); 
            const [questionHtml, setQuestionHtml] = useState("");
            const [opinionAnswer, setOpinionAnswer] = useState("");
            const [opinionFeedback, setOpinionFeedback] = useState(null);
            const [selectedColor, setSelectedColor] = useState("bg-yellow-200"); 
            const [results, setResults] = useState([]); 

            const textRef = useRef(null);
            const questionRef = useRef(null);
            const currentQuestion = questions[currentQIndex];

            // --- Inicializaci√≥n del Texto ---
            useEffect(() => {
                let htmlContent = `
                    <div class="font-serif text-gray-800">
                        <h2 class="text-3xl font-bold text-center text-red-900 mb-2 font-hand">${textContent.title}</h2>
                        <p class="text-center text-gray-600 italic mb-6">¬°Convi√©rtete en el capit√°n de los siete mares!</p>
                        
                        <div class="bg-amber-50 p-4 rounded-lg border-2 border-amber-200 mb-6 shadow-sm">
                            <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">üõ†Ô∏è Materiales:</h3>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                <li>Una hoja grande de <strong>cartulina negra</strong>.</li>
                                <li>Tijeras (punta redonda).</li>
                                <li>Pegamento en barra o cinta adhesiva.</li>
                                <li>L√°piz de color blanco, tiza o corrector.</li>
                            </ul>
                        </div>

                        <div class="space-y-6">
                            <div class="flex gap-4">
                                <div class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 border-2 border-red-200">1</div>
                                <div>
                                    <h4 class="font-bold text-lg text-indigo-900">Dibuja la forma</h4>
                                    <p>Sobre la <strong>cartulina negra</strong>, dibuja la forma de un sombrero grande. Intenta hacer una forma de nube ancha o usa un plato grande para guiarte y hacer las curvas del tricornio.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 border-2 border-red-200">2</div>
                                <div>
                                    <h4 class="font-bold text-lg text-indigo-900">Recorta con cuidado</h4>
                                    <p>Toma las tijeras y <strong>recorta</strong> siguiendo la l√≠nea que dibujaste. Pide ayuda a un adulto si la cartulina es muy dura.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 border-2 border-red-200">3</div>
                                <div>
                                    <h4 class="font-bold text-lg text-indigo-900">Prepara el cintillo</h4>
                                    <p>Corta una <strong>tira larga</strong> y rectangular de la cartulina sobrante. Mide tu cabeza con ella y pega los extremos para formar un c√≠rculo de <strong>tu talla</strong>. Esto sostendr√° el sombrero.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 border-2 border-red-200">4</div>
                                <div>
                                    <h4 class="font-bold text-lg text-indigo-900">Arma tu sombrero</h4>
                                    <p>Pega la silueta del sombrero (que recortaste en el paso 2) sobre la parte frontal del cintillo circular.</p>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 border-2 border-red-200">5</div>
                                <div>
                                    <h4 class="font-bold text-lg text-indigo-900">¬°A decorar!</h4>
                                    <p>Usa el <strong>l√°piz blanco</strong> o tiza para dibujar una calavera y huesos cruzados en el centro del sombrero. ¬°Listo, capit√°n!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                htmlContent += `<p class="text-center text-sm text-gray-400 italic mt-8 border-t pt-2">Texto adaptado para fines educativos.</p>`;
                setTextHtml(htmlContent);
            }, []);

            // --- Actualizaci√≥n de Pregunta ---
            useEffect(() => {
                if (!isFinished) {
                    setQuestionHtml(currentQuestion.text);
                    setSelectedOption(null);
                    setIsCorrect(null);
                    setShowFeedback(false);
                    setOpinionAnswer("");
                    setOpinionFeedback(null);
                }
            }, [currentQIndex, isFinished]);

            // --- L√≥gica de Inicio ---
            const handleStart = () => {
                if (studentName.trim() !== "") setHasStarted(true);
                else alert("¬°Arrgh! Escribe tu nombre para zarpar, grumete.");
            };

            // --- L√≥gica de Destacado ---
            const highlightSelection = (containerRef, setHtmlFn) => {
                const selection = window.getSelection();
                if (!selection.rangeCount || selection.isCollapsed) return;
                const range = selection.getRangeAt(0);
                const container = containerRef.current;

                if (container && container.contains(range.commonAncestorContainer)) {
                    const span = document.createElement("span");
                    let colorHex = "#fef08a"; // Amarillo
                    if (selectedColor === "bg-cyan-200") colorHex = "#a5f3fc";
                    if (selectedColor === "bg-green-200") colorHex = "#bbf7d0";
                    if (selectedColor === "bg-pink-200") colorHex = "#fbcfe8";

                    span.style.backgroundColor = colorHex;
                    span.style.borderRadius = "2px";
                    span.style.padding = "0 2px";
                    span.style.boxShadow = "0 1px 2px rgba(0,0,0,0.1)";
                    
                    try {
                        range.surroundContents(span);
                        selection.removeAllRanges();
                        setHtmlFn(container.innerHTML);
                    } catch (e) {
                        alert("Intenta seleccionar solo texto continuo.");
                    }
                } else {
                    alert("Selecciona texto dentro del √°rea correcta para destacar.");
                }
            };

            // --- L√≥gica de Respuestas ---
            const handleCheckAnswer = () => {
                if (selectedOption === null) return;
                const correct = selectedOption === currentQuestion.correct;
                setIsCorrect(correct);
                setShowFeedback(true);
                const newResult = {
                    question: currentQuestion.text,
                    isCorrect: correct
                };
                setResults(prev => [...prev.filter(r => r.question !== currentQuestion.text), newResult]);
            };

            const handleOpinionSubmit = () => {
                const lowerAnswer = opinionAnswer.toLowerCase();
                const checks = {
                    posture: lowerAnswer.includes("s√≠") || lowerAnswer.includes("si") || lowerAnswer.includes("no") || lowerAnswer.includes("creo") || lowerAnswer.includes("opino") || lowerAnswer.includes("importante"),
                    reason: lowerAnswer.includes("porque") || lowerAnswer.includes("ya que") || lowerAnswer.includes("para que"),
                    pirateRef: lowerAnswer.includes("pirata") || lowerAnswer.includes("miedo") || lowerAnswer.includes("capit√°n") || lowerAnswer.includes("s√≠mbolo") || lowerAnswer.includes("reconozcan")
                };
                let score = 0;
                if (checks.posture) score++;
                if (checks.reason) score++;
                if (checks.pirateRef) score++;

                let feedbackMsg = score === 3 ? `¬°Excelente, Capit√°n ${studentName}! Tomaste postura, explicaste el 'porqu√©' y mencionaste el tema pirata.` :
                                  score === 2 ? `¬°Vas muy bien, ${studentName}! Revisa: ¬øDijiste por qu√©? ¬øMencionaste a los piratas o su s√≠mbolo?` :
                                  `Int√©ntalo de nuevo, ${studentName}. Recuerda decir qu√© piensas y explicarlo usando el tema del texto.`;
                setOpinionFeedback({ score, msg: feedbackMsg });
                setResults(prev => [...prev.filter(r => r.question !== currentQuestion.text), {
                    question: currentQuestion.text,
                    isCorrect: score >= 2
                }]);
            };

            const nextQuestion = () => {
                if (currentQIndex < questions.length - 1) setCurrentQIndex(currentQIndex + 1);
                else setIsFinished(true);
            };

            // --- Reporte Final ---
            const generateReport = () => {
                const date = new Date().toLocaleDateString();
                let report = `REPORTE DE LECTURA - 4¬∞ B√ÅSICO\nFecha: ${date}\nEstudiante: ${studentName}\nCurso: ${studentCourse}\nActividad: Sombrero Pirata\n--------------------------------\n`;
                let correctCount = 0;
                results.forEach((r, idx) => {
                    if (r.isCorrect) correctCount++;
                    report += `P${idx + 1}: ${r.isCorrect ? "CORRECTA" : "INCORRECTA"}\n`;
                });
                report += `--------------------------------\nPUNTAJE FINAL: ${correctCount} / ${questions.length}\n`;
                return report;
            };

            const handleDownloadReport = () => {
                const element = document.createElement("a");
                const file = new Blob([generateReport()], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `Reporte_Pirata_${studentName.replace(/\s+/g, '_')}.txt`;
                document.body.appendChild(element);
                element.click();
            };

            // --- PANTALLA INICIO ---
            if (!hasStarted) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4" style={{
                        backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E")`
                    }}>
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border-b-8 border-red-500 relative overflow-hidden fade-in">
                            <div className="absolute top-0 left-0 w-full h-2 bg-red-500"></div>
                            <div className="flex justify-center mb-4"><div className="bg-red-100 p-4 rounded-full"><Icons.Anchor size={48} className="text-red-700" /></div></div>
                            <h1 className="text-3xl font-bold text-center text-gray-900 mb-2 font-hand">¬°Misi√≥n Pirata!</h1>
                            <p className="text-center text-gray-600 mb-6">Lee el instructivo para crear tu propio sombrero y responde las preguntas.</p>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Nombre del Grumete:</label>
                                    <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 outline-none" placeholder="Escribe tu nombre..." />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Tu tripulaci√≥n:</label>
                                    <select value={studentCourse} onChange={(e) => setStudentCourse(e.target.value)} className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-red-500 outline-none bg-white">
                                        <option>4¬∞A</option><option>4¬∞B</option><option>4¬∞C</option>
                                    </select>
                                </div>
                                <button onClick={handleStart} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg flex justify-center items-center gap-2"><Icons.Skull size={20}/> ¬°Zarpar!</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- PANTALLA FINAL ---
            if (isFinished) {
                const score = results.filter(r => r.isCorrect).length;
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center border-b-8 border-yellow-500 fade-in">
                            <div className="flex justify-center mb-4"><div className="bg-yellow-100 p-4 rounded-full animate-bounce"><Icons.CheckCircle size={48} className="text-yellow-600" /></div></div>
                            <h2 className="text-3xl font-bold text-gray-800 mb-2 font-hand">¬°Tesoro Conseguido!</h2>
                            <p className="text-gray-600 mb-6">¬°Gran trabajo, Capit√°n {studentName}!</p>
                            <div className="bg-gray-100 p-6 rounded-lg mb-6">
                                <p className="text-sm text-gray-500 uppercase font-bold tracking-wide">Tu Bot√≠n (Puntaje)</p>
                                <p className="text-5xl font-bold text-indigo-600">{score} / {questions.length}</p>
                            </div>
                            <div className="flex flex-col gap-3">
                                <button onClick={() => navigator.clipboard.writeText(generateReport())} className="flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition"><Icons.Copy size={20} /> Copiar reporte</button>
                                <button onClick={handleDownloadReport} className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition"><Icons.Download size={20} /> Descargar reporte</button>
                                <button onClick={() => window.location.reload()} className="mt-2 text-indigo-500 font-bold hover:underline text-sm">Volver a empezar</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- PANTALLA PRINCIPAL ---
            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto" style={{backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E")`}}>
                    <header className="flex flex-col md:flex-row items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-md border-b-4 border-red-600 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="bg-red-100 p-2 rounded-full"><Icons.User size={24} className="text-red-700" /></div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800 font-hand">Tripulante: {studentName}</h1>
                                <p className="text-red-600 text-xs font-bold uppercase">{studentCourse} - Comprensi√≥n Lectora</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200">
                            <span className="text-xs font-bold text-gray-500 mr-1">Marcador:</span>
                            {["bg-yellow-200", "bg-cyan-200", "bg-green-200", "bg-pink-200"].map(c => (
                                <button key={c} onClick={() => setSelectedColor(c)} className={`w-6 h-6 rounded-full ${c} border-2 ${selectedColor === c ? "border-red-500 scale-110" : "border-gray-300"}`}></button>
                            ))}
                        </div>
                    </header>
                    <div className="w-full bg-gray-200 rounded-full h-3 mb-6 overflow-hidden border border-gray-300">
                        <div className="bg-red-500 h-full transition-all duration-500" style={{ width: `${((currentQIndex + 1) / questions.length) * 100}%` }}></div>
                    </div>
                    <main className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="flex flex-col gap-2 h-full">
                            <div className="flex justify-between items-center bg-gray-800 text-white p-3 rounded-t-xl px-4 shadow-sm">
                                <span className="flex items-center gap-2 font-bold text-sm"><Icons.BookOpen size={16}/> Texto Instructivo</span>
                                <button onClick={() => highlightSelection(textRef, setTextHtml)} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1 border border-white/40"><Icons.Highlighter size={12}/> destacar</button>
                            </div>
                            <div className="bg-white p-6 rounded-b-xl shadow-lg border-2 border-gray-200 flex-grow text-lg leading-relaxed overflow-y-auto max-h-[600px]" ref={textRef} dangerouslySetInnerHTML={{ __html: textHtml }} />
                        </div>
                        <div className="flex flex-col gap-2 h-full">
                            <div className="flex justify-between items-center bg-sky-700 text-white p-3 rounded-t-xl px-4 shadow-sm">
                                <span className="flex items-center gap-2 font-bold text-sm"><Icons.HelpCircle size={16}/> Pregunta {currentQIndex + 1}</span>
                                <button onClick={() => highlightSelection(questionRef, setQuestionHtml)} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1 border border-white/40"><Icons.PenTool size={12}/> destacar clave</button>
                            </div>
                            <div className="bg-white p-6 rounded-b-xl shadow-lg border-2 border-sky-100 flex-grow flex flex-col justify-between">
                                <div>
                                    <div className="text-xl font-medium text-gray-800 mb-6" ref={questionRef} dangerouslySetInnerHTML={{ __html: questionHtml }} />
                                    {currentQuestion.type === "opinion" ? (
                                        <div className="space-y-4 fade-in">
                                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                                <p className="text-sm text-blue-800 mb-2 font-bold">üí° Lista de cotejo:</p>
                                                <ul className="list-disc list-inside text-sm text-blue-700">{currentQuestion.checklist.map((item, idx) => <li key={idx}>{item}</li>)}</ul>
                                            </div>
                                            <textarea className="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-sky-500 outline-none" rows="4" placeholder={currentQuestion.placeholder} value={opinionAnswer} onChange={(e) => setOpinionAnswer(e.target.value)}></textarea>
                                            {!opinionFeedback ? (
                                                <button onClick={handleOpinionSubmit} className="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><Icons.Send size={18}/> Enviar opini√≥n</button>
                                            ) : (
                                                <div className={`p-4 rounded-lg border ${opinionFeedback.score >= 2 ? 'bg-green-100 border-green-300' : 'bg-orange-100 border-orange-300'}`}>
                                                    <p className="font-bold mb-2 text-sm">{opinionFeedback.score >= 2 ? 'üåü ¬°Excelente!' : 'üìù Vamos a mejorar:'}</p>
                                                    <p className="text-sm">{opinionFeedback.msg}</p>
                                                    {opinionFeedback.score >= 2 ? <button onClick={nextQuestion} className="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm">Siguiente</button> : <button onClick={() => setOpinionFeedback(null)} className="mt-3 bg-orange-500 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm">Editar</button>}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {currentQuestion.options.map((option, idx) => (
                                                <button key={idx} onClick={() => !showFeedback && setSelectedOption(idx)} className={`w-full text-left p-4 rounded-lg border-2 transition-all flex items-center gap-3 relative ${selectedOption === idx ? 'border-sky-500 bg-sky-50' : 'border-gray-200 hover:border-sky-300'} ${showFeedback && idx === currentQuestion.correct ? '!bg-green-100 !border-green-500' : ''} ${showFeedback && selectedOption === idx && idx !== currentQuestion.correct ? '!bg-red-50 !border-red-400' : ''}`} disabled={showFeedback}>
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${selectedOption === idx ? 'bg-sky-600 text-white' : 'bg-gray-200 text-gray-500'} ${showFeedback && idx === currentQuestion.correct ? '!bg-green-600 !text-white' : ''} ${showFeedback && selectedOption === idx && idx !== currentQuestion.correct ? '!bg-red-500 !text-white' : ''}`}>{String.fromCharCode(65 + idx)}</div>
                                                    <span className="font-medium text-gray-700">{option}</span>
                                                    {showFeedback && idx === currentQuestion.correct && <Icons.CheckCircle className="absolute right-4 text-green-600" size={24} />}
                                                    {showFeedback && selectedOption === idx && idx !== currentQuestion.correct && <Icons.XCircle className="absolute right-4 text-red-500" size={24} />}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {currentQuestion.type !== "opinion" && (
                                    <div className="mt-6">
                                        {!showFeedback ? (
                                            <button onClick={handleCheckAnswer} disabled={selectedOption === null} className={`w-full py-3 rounded-lg font-bold text-lg shadow-md transition ${selectedOption !== null ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>Comprobar respuesta</button>
                                        ) : (
                                            <div className={`rounded-lg p-4 mt-4 fade-in border-l-4 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`}>
                                                <h4 className={`font-bold ${isCorrect ? 'text-green-800' : 'text-red-800'}`}>{isCorrect ? `¬°Bien hecho, ${studentName}!` : `¬°Cuidado, ${studentName}!`}</h4>
                                                <p className="text-gray-700 text-sm leading-relaxed">{isCorrect ? currentQuestion.feedbackCorrect(studentName) : currentQuestion.feedbackWrong(studentName)}</p>
                                                {!isCorrect && <div className="mt-2 text-xs font-bold text-amber-800 bg-amber-100 px-3 py-2 rounded-md border border-amber-200">‚öì Pista: {currentQuestion.hint}</div>}
                                                {isCorrect ? <button onClick={nextQuestion} className="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow-sm w-full md:w-auto">Siguiente</button> : <button onClick={() => { setShowFeedback(false); setSelectedOption(null); }} className="mt-4 text-red-600 font-bold hover:underline text-sm">Intentar otra vez</button>}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                    <footer className="mt-8 text-center text-gray-400 text-xs"><span>Actividad de 4¬∞ B√°sico - Tema: Instructivo Pirata</span></footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
